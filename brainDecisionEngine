// =======================================================
// brainDecisionEngine.js
// Ø¹Ù‚Ù„ Ø§ØªØ®Ø§Ø° Ø§Ù„Ù‚Ø±Ø§Ø± â€“ AI Ø£Ù… Knowledge Ø£Ù… Fallback
// =======================================================

const fetch = require("node-fetch");
const Fallback = require("./brainFallback");
const { NOVA_BRAIN_V3 } = require("./nova-brain.v3.config");

async function callGemini(model, prompt) {
  const KEY = process.env.GEMINI_API_KEY;
  if (!KEY) throw new Error("Gemini key missing");

  const url =
    `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${KEY}`;

  const body = {
    contents: [{ role: "user", parts: [{ text: prompt }] }],
    generationConfig: {
      maxOutputTokens: NOVA_BRAIN_V3.AI_ENGINE.MAX_TOKENS,
      temperature: NOVA_BRAIN_V3.AI_ENGINE.TEMPERATURE
    }
  };

  const res = await fetch(url, {
    method: "POST",
    body: JSON.stringify(body),
    headers: { "Content-Type": "application/json" }
  });

  if (!res.ok) throw new Error("Gemini API error");

  const data = await res.json();
  return data?.candidates?.[0]?.content?.parts?.[0]?.text || null;
}

// --------------------------------------------------------
// Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
// --------------------------------------------------------
async function decideReply({ question, intent, lang, dialect, domainAI, match, score, history, config }) {

  // 1) ØªØ·Ø§Ø¨Ù‚ Ù‚ÙˆÙŠ Ù…Ø¹ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª
  if (match && score >= 0.65) {
    return {
      ok: true,
      provider: "knowledge-strong",
      answer:
        `ğŸ’¬ ÙŠØ¨Ø¯Ùˆ Ø£Ù†Ùƒ ØªØ¨Ø­Ø« ÙÙŠ Ù…ÙˆØ¶ÙˆØ¹ Ù†Ø§Ù‚Ø´Ù†Ø§Ù‡:\nâ€œ${match.title}â€\n\n` +
        `<a href="${match.url}" target="_blank">Ø§Ù‚Ø±Ø£ Ø§Ù„Ù…Ù‚Ø§Ù„</a>`
    };
  }

  // 2) ØªØ·Ø§Ø¨Ù‚ Ù…ØªÙˆØ³Ø· â†’ Ø¬Ø±Ù‘Ø¨ AI Ø£ÙˆÙ„Ø§Ù‹
  if (match && score >= 0.35 && config.AI_ENGINE.ENABLED) {
    try {
      const prompt = buildPrompt(question, match, intent, config);
      const ans = await callGemini("gemini-2.0-flash", prompt);

      if (ans) {
        return {
          ok: true,
          provider: "gemini-flash",
          answer: ans +
            `<br><br><a href="${match.url}" target="_blank">Ø§Ù‚Ø±Ø£ Ø§Ù„Ù…Ø²ÙŠØ¯</a>`
        };
      }
    } catch (e) {}
  }

  // 3) Ø³Ø¤Ø§Ù„ Ø¹Ù† AI â†’ Ø£Ø±Ø³Ù„ Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
  if (domainAI && config.AI_ENGINE.ENABLED) {
    try {
      const prompt = buildPrompt(question, null, intent, config);
      const ans = await callGemini("gemini-2.0-flash", prompt);

      if (ans) {
        return { ok: true, provider: "gemini-flash", answer: ans };
      }
    } catch (e) {}
  }

  // 4) fallback
  return {
    ok: true,
    provider: "automated",
    answer: Fallback.automatedReply(intent, lang)
  };
}

// Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª
function buildPrompt(question, context, intent, config) {
  let ctx = "";
  if (context) {
    ctx = `
Ø§Ø³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ù† Ù†ÙˆÙØ§ Ù„ÙŠÙ†Ùƒ Ø¥Ù† ÙƒØ§Ù† Ù…Ù†Ø§Ø³Ø¨Ù‹Ø§:
Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${context.title}
Ø§Ù„ÙˆØµÙ: ${context.description}
Ø§Ù„Ù…Ù‚ØªØ·Ù: ${context.excerpt}
    `;
  }

  return `
Ø£Ù†Øª Ù…Ø³Ø§Ø¹Ø¯ ${config.META.BRAND_NAME}.
Ø£Ø¬Ø¨ Ø¨ÙˆØ¶ÙˆØ­ ÙˆØ¨Ø§Ø®ØªØµØ§Ø± Ù„Ø§ ÙŠØªØ¬Ø§ÙˆØ² ${config.AI_ENGINE.MAX_TOKENS} ØªÙˆÙƒÙ†.

Ø§Ù„Ø³Ø¤Ø§Ù„:
${question}

${ctx}

Ù‚Ø¯Ù… Ø¬ÙˆØ§Ø¨Ù‹Ø§ Ø¹Ù…Ù„ÙŠÙ‹Ø§ ÙˆÙ…Ø¨Ø§Ø´Ø±Ù‹Ø§.
  `;
}

async function testGemini(text) {
  return callGemini("gemini-2.0-flash", text);
}

module.exports = {
  decideReply,
  testGemini
};
