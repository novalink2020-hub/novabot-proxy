// =======================================================
// brainDecisionEngine.js
// Core Logic for NovaBrain v3.0
// ÙŠØµÙ†Ø¹ Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: AI / Automated / Knowledge / Products / Human
// Ù…Ø·ÙˆÙ‘Ø±: Ù…Ø­Ù…Ø¯ Ø£Ø¨Ùˆ Ø³Ù†ÙŠÙ†Ø© â€“ NOVALINK.AI
// =======================================================

const { NOVA_BRAIN_V3 } = require("./nova-brain.v3.config.js");
const { detectIntentDetailed, isAIDomainQuestion } = require("./brainIntentDetector.js");
const { getFallbackReply } = require("./brainFallback.js");

async function brainDecisionEngine(question, channel = "web", history = []) {

  const brain = NOVA_BRAIN_V3;
  const profile = brain.PROFILE;
  const modes = brain.BUSINESS_MODES[profile.BUSINESS_TYPE]?.[channel] || {};

  // 1) ÙƒØ´Ù Ø§Ù„Ù„ØºØ©
  const language = /[a-zA-Z]/.test(question) ? "en" : "ar";

  // 2) Ø§ÙƒØªØ´Ø§Ù Ø¨ÙŠØ¦Ø© Ø§Ù„Ø¹Ù…Ù„
  const isBlog       = profile.BUSINESS_TYPE === "blog";
  const isStore      = profile.BUSINESS_TYPE === "ecommerce";
  const isService    = profile.BUSINESS_TYPE === "service";

  // 3) ÙƒØ´Ù Ø§Ù„Ù†ÙŠØ© ÙˆØ§Ù„Ù…Ø¬Ø§Ù„
  const intent = detectIntentDetailed(question, language);
  const inAIDomain = isAIDomainQuestion(question, brain);

  // 4) ØªØ­Ø¯ÙŠØ¯ Ù†ÙˆØ¹ Ø§Ù„Ø±Ø¯ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
  const useAI = (() => {
    if (!brain.AI_ENGINE.ENABLED) return false;
    if (!inAIDomain && brain.AI_ENGINE.ONLY_AI_DOMAIN_USES_LLM) return false;
    return true;
  })();

  // 5) Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ù„Ù„Ø±Ø¯
  let responseType = "automated";
  let responseSource = "none";
  let selectedKnowledge = null;
  let selectedProduct = null;
  let needsHuman = false;

  // ---------------------------------------------------
  // 6) ÙÙŠ Ø­Ø§Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„ ØªØ¹Ø±ÙŠÙÙŠ Ø¹Ù† Ù†ÙˆÙØ§ Ù„ÙŠÙ†Ùƒ â€“ Ø§Ù„Ø±Ø¯ Ø¬Ø§Ù‡Ø²
  // ---------------------------------------------------
  if (intent === "ABOUT") {
    return {
      type: "automated",
      content: brain.RESPONSES.ABOUT_NOVALINK.WHO_WE_ARE,
      provider: "built-in",
      intent,
      needsHuman: false
    };
  }

  // ---------------------------------------------------
  // 7) Ù…Ù‚Ø§Ù„Ø§Øª/Ù…Ø¹Ø±ÙØ© (blog mode)
  // ---------------------------------------------------
  if (isBlog && modes.USE_KNOWLEDGE) {
    selectedKnowledge = await pickBestKnowledgeMatch(question);
    if (selectedKnowledge && selectedKnowledge.score >= 0.45) {
      return {
        type: "knowledge",
        provider: "match",
        content:
          `ğŸ’¬ ÙŠØ¨Ø¯Ùˆ Ø£Ù† Ø³Ø¤Ø§Ù„Ùƒ ÙŠØ±ØªØ¨Ø· Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹:<br>` +
          `â€œ${selectedKnowledge.item.title}â€<br>` +
          `ğŸ”— <a class="nova-link" target="_blank" href="${selectedKnowledge.item.url}">Ø§Ù‚Ø±Ø£ Ø§Ù„Ù…Ù‚Ø§Ù„</a>`,
        intent,
        needsHuman: false
      };
    }
  }

  // ---------------------------------------------------
  // 8) Ù…Ù†ØªØ¬Ø§Øª (ecommerce)
  // ---------------------------------------------------
  if (isStore && modes.USE_PRODUCTS) {
    selectedProduct = await pickBestProductMatch(question);
    if (selectedProduct) {
      if (intent === "PURCHASE" || intent === "LEARNING") {
        return {
          type: "product",
          provider: "catalog",
          product: selectedProduct,
          content:
            `ğŸ›’ Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù†Ø§Ø³Ø¨Ù‹Ø§ Ù„Ùƒ:<br>` +
            `<strong>${selectedProduct.title}</strong><br>` +
            `Ø§Ù„Ø³Ø¹Ø±: ${selectedProduct.price} ${selectedProduct.currency}<br>` +
            `ğŸ”— <a class="nova-link" target="_blank" href="${selectedProduct.url}">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬</a>`,
          intent,
          needsHuman: modes.REQUIRE_HUMAN_ON_PURCHASE
        };
      }
    }
  }

  // ---------------------------------------------------
  // 9) Ø¥Ø°Ø§ Ø£Ø±Ø¯Ù†Ø§ Ø§Ø³ØªØ®Ø¯Ø§Ù… AI Engine
  // ---------------------------------------------------
  if (useAI) {
    return {
      type: "ai",
      provider: "llm",
      intent,
      context: selectedKnowledge,
      history,
      needsHuman: false
    };
  }

  // ---------------------------------------------------
  // 10) fallback Ù…Ø¤ØªÙ…Øª â€“ Ø¢Ø®Ø± Ø®Ø· Ø¯ÙØ§Ø¹
  // ---------------------------------------------------
  const fallback = getFallbackReply(intent, brain);

  return {
    type: "automated",
    provider: "fallback",
    content: fallback,
    intent,
    needsHuman: shouldEscalateToHuman(intent, profile.BUSINESS_TYPE, brain)
  };
}

// =======================================================
// Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© ØªØ­Ø¯Ø¯ Ù‡Ù„ ÙŠØ¬Ø¨ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù…ÙˆØ¸Ù
// =======================================================
function shouldEscalateToHuman(intent, businessType, brain) {
  const rules = brain.HANDOFF;
  if (!rules.ENABLED) return false;

  const types = rules.BY_BUSINESS_TYPE[businessType];
  if (!types) return false;

  return types.TRIGGER_ON_INTENTS.includes(intent);
}

// =======================================================
async function pickBestKnowledgeMatch(q) {
  return null; // placeholder â€“ Ø³ÙŠØªÙ… Ø¨Ù†Ø§Ø¤Ù‡Ø§ ÙÙŠ Ø®Ø·ÙˆØ© Ù„Ø§Ø­Ù‚Ø©
}

async function pickBestProductMatch(q) {
  return null; // placeholder â€“ Ø³ÙŠØªÙ… Ø¨Ù†Ø§Ø¤Ù‡Ø§ Ù„Ø§Ø­Ù‚Ù‹Ø§
}

// =======================================================
module.exports = { brainDecisionEngine };
