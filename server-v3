// =======================================================
// server-v3.js â€” NovaBot v3 Core Server
// Primary AI Processor (Render) + Cloudflare Failover
// Ø§Ù„Ù…Ø·ÙˆØ±: Ù…Ø­Ù…Ø¯ Ø£Ø¨Ùˆ Ø³Ù†ÙŠÙ†Ø© â€“ NOVALINK.AI
// =======================================================

require("dotenv").config();
const express = require("express");
const cors = require("cors");
const fetch = require("node-fetch");

const { NOVA_BRAIN_V3 } = require("./nova-brain.v3.config");
const {
  detectIntent,
  detectAIDomain,
  detectLanguage,
  detectDialect
} = require("./brainIntentDetector");

const { matchKnowledge } = require("./brainKnowledgeEngine");
const { decideResponseFlow } = require("./brainDecisionEngine");
const { automatedFallbackReply } = require("./brainFallback");

const app = express();
app.use(express.json({ limit: "1mb" }));
app.use(cors({
  origin: (origin, cb) => {
    const allowed = NOVA_BRAIN_V3.NETWORK.ALLOWED_ORIGINS || [];
    if (!origin || allowed.includes(origin)) return cb(null, true);
    cb(new Error("CORS Blocked"), false);
  }
}));

// =======================================================
// ðŸ” Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ù…Ù† Render
// =======================================================
const GEMINI_KEY = process.env.GEMINI_API_KEY || "";
const GITHUB_TOKEN = process.env.GITHUB_TOKEN || "";

// -------------------------------------------------------
// ðŸ§  Gemini Call
// -------------------------------------------------------
async function runGeminiPrompt(prompt) {
  try {
    const url =
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_KEY}`;

    const body = {
      contents: [{ role: "user", parts: [{ text: prompt }] }],
      generationConfig: {
        maxOutputTokens: NOVA_BRAIN_V3.AI_ENGINE.MAX_TOKENS,
        temperature: NOVA_BRAIN_V3.AI_ENGINE.TEMPERATURE
      }
    };

    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });

    if (!res.ok) return null;

    const json = await res.json();
    return json?.candidates?.[0]?.content?.parts?.[0]?.text || null;

  } catch {
    return null;
  }
}

// -------------------------------------------------------
// ðŸŒ Cloudflare Worker Fallback Call
// -------------------------------------------------------
async function callCloudflareFallback(question, history) {
  try {
    const url =
      "https://novalinksecuregeminiproxy.novalink2020.workers.dev/api/nova";

    const res = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ question, history })
    });

    if (!res.ok) return null;

    const json = await res.json();
    return json.answer || null;

  } catch {
    return null;
  }
}

// -------------------------------------------------------
// ðŸ§  Core Route â€” /api/nova-ai
// -------------------------------------------------------
app.post("/api/nova-ai", async (req, res) => {
  try {
    const { question, history = [] } = req.body;

    if (!question)
      return res.json({ ok: false, error: "no_question" });

    // Ù„ØºØ© + Ù„Ù‡Ø¬Ø©
    const lang = detectLanguage(question);
    const dialect = lang === "ar" ? detectDialect(question) : "n/a";

    // Ù†ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const intent = detectIntent(question, lang);

    // Ù‡Ù„ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø¶Ù…Ù† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠØŸ
    const isAI = detectAIDomain(question, lang);

    // Ø£ÙˆÙ„ Ø´ÙŠØ¡: Ø­Ø§ÙˆÙ„ Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ù„Ù…Ø¹Ø±ÙØ©
    const knowledgeMatch = await matchKnowledge(question);

    // Ù‚Ø±Ø§Ø± Ø§Ù„ØªØ¯ÙÙ‚
    const flow = decideResponseFlow({
      isAI,
      intent,
      knowledgeMatch,
      lang,
      businessType: NOVA_BRAIN_V3.PROFILE.BUSINESS_TYPE
    });

    // ---------------------------------------------------
    // 1) Ø§Ù„Ø±Ø¯ Ù…Ù† Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ø¹Ø±ÙØ© Ù„Ùˆ Ù…ØªÙˆÙØ±
    // ---------------------------------------------------
    if (flow.useKnowledgeMatch && knowledgeMatch) {
      return res.json({
        ok: true,
        provider: "knowledge",
        answer: knowledgeMatch.answer,
        source: knowledgeMatch.url
      });
    }

    // ---------------------------------------------------
    // 2) Ø§Ù„Ø­Ù…Ø§ÙŠØ© â€” Ø¥Ø°Ø§ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙØªØ§Ø­ Gemini â†’ Ù…Ø¤ØªÙ…Øª
    // ---------------------------------------------------
    if (!GEMINI_KEY && isAI) {
      return res.json({
        ok: true,
        provider: "automated-no-gemini",
        answer: automatedFallbackReply({ intent, lang })
      });
    }

    // ---------------------------------------------------
    // 3) Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Gemini Ù…Ø¨Ø§Ø´Ø±Ø©
    // ---------------------------------------------------
    if (isAI) {
      const aiAnswer = await runGeminiPrompt(question);

      if (aiAnswer) {
        return res.json({
          ok: true,
          provider: "gemini-direct",
          answer: aiAnswer
        });
      }
    }

    // ---------------------------------------------------
    // 4) Render ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© â†’ Cloudflare Worker Fallback
    // ---------------------------------------------------
    const fallbackCF = await callCloudflareFallback(question, history);

    if (fallbackCF) {
      return res.json({
        ok: true,
        provider: "cloudflare-fallback",
        answer: fallbackCF
      });
    }

    // ---------------------------------------------------
    // 5) Ø§Ù„ÙÙˆÙ„Ø¨Ø§Ùƒ Ø§Ù„Ø£Ø®ÙŠØ± (Ø¥Ø¬Ø§Ø¨Ø§Øª Ù…Ø¤ØªÙ…ØªØ©)
    // ---------------------------------------------------
    return res.json({
      ok: true,
      provider: "hard-fallback",
      answer: automatedFallbackReply({ intent, lang })
    });

  } catch (err) {
    return res.json({
      ok: true,
      provider: "exception-fallback",
      answer: automatedFallbackReply({ intent: "GENERAL", lang: "ar" })
    });
  }
});

// -------------------------------------------------------
// Health Check
// -------------------------------------------------------
app.get("/", (_req, res) => {
  res.send("NovaBot v3 server running âœ”");
});

// -------------------------------------------------------
const PORT = process.env.PORT || 3000;
app.listen(PORT, () =>
  console.log(`NovaBot v3 running on port ${PORT}`)
);
