// ===========================================
// novaIntentDetector.js
// ÙƒØ´Ù Ù†ÙˆØ§ÙŠØ§ Ù†ÙˆÙØ§ Ø¨ÙˆØª (Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ + ØªØ·ÙˆÙŠØ± Ø£Ø¹Ù…Ø§Ù„ + Ù†ÙˆØ§ÙŠØ§ ØªØ¹Ø±ÙŠÙÙŠØ©)
// By Mohammed Abu Snaina â€“ NOVALINK.AI
// ===========================================

/**
 * Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªØµÙ…ÙŠÙ…:
 * - ÙÙ‚Ø· intent: "ai_business" ÙŠØ³ØªØ¯Ø¹ÙŠ Gemini Ù…Ù† novaBrainSystem.
 * - Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù†ÙˆØ§ÙŠØ§ ØªØ³ØªØ®Ø¯Ù… Ø±Ø¯ÙˆØ¯ Ø«Ø§Ø¨ØªØ© Ù…Ø¤ØªÙ…ØªØ© (ØµÙØ± ØªÙƒÙ„ÙØ© ØªÙˆÙƒÙ†Ø²).
 * - Ø£ÙŠ Ù…ÙˆØ¶ÙˆØ¹ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙˆØªØ·ÙˆÙŠØ± Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ â†’ out_of_scope â†’ Ø±Ø¯ ØªØ­ÙÙŠØ²ÙŠ.
 * - Ø¯Ø¹Ù… Ù„Ù‡Ø¬Ø§Øª: Ø´Ø§Ù…ÙŠØ©ØŒ Ù…ØµØ±ÙŠØ©ØŒ Ø®Ù„ÙŠØ¬ÙŠØ©ØŒ Ù…ØºØ§Ø±Ø¨ÙŠØ© Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙÙ‚Ø·.
 */
console.log("ðŸŽ¯ IntentDetector V5.1 loaded at", new Date().toISOString());
const ARABIC_RANGE_RE = /[\u0600-\u06FF]/;

/* ================= Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ù†Øµ ================= */

function normalize(str = "") {
  return str
    .toLowerCase()
    .replace(/[.,!?ØŸØŒ"â€œâ€()\-_:\;Â«Â»[\]{}/\\]+/g, " ")
    .replace(/\s+/g, " ")
    .trim();
}

function containsAny(text, list) {
  if (!text) return false;
  for (const kw of list) {
    if (!kw) continue;
    if (text.includes(kw)) return true;
  }
  return false;
}

function scoreByKeywords(text, list) {
  if (!text) return 0;
  let score = 0;
  for (const kw of list) {
    if (!kw) continue;
    if (text.includes(kw)) score += 1;
  }
  return score;
}

/* ============== ÙƒØ´Ù Ø§Ù„Ù„ØºØ© ÙˆØ§Ù„Ù„Ù‡Ø¬Ø© ============== */

function detectLanguage(originalText = "") {
  if (!originalText) return "ar";
  return ARABIC_RANGE_RE.test(originalText) ? "ar" : "en";
}

function detectDialect(cleanText = "") {
  // Ø´Ø§Ù…ÙŠØ©
  const levantWords = [
    "Ø´Ùˆ",
    "Ù„ÙŠØ´",
    "Ù„Ù‡ÙŠÙƒ",
    "Ù‡ÙŠÙƒ",
    "Ù„Ø³Ø§",
    "Ù„Ø³Ù‡",
    "Ù‡Ø³Ø§",
    "Ø³Ù„Ø§Ù…Ø§Øª",
    "ØªÙ…Ø§Ù… Ø¹Ù„ÙŠÙƒ",
    "Ø¨Ø¯ÙŠ",
    "Ø¨Ø¯Ùƒ",
    "ÙƒØªÙŠØ±",
    "Ø¹Ù†Ø¬Ø¯",
    "Ù…Ùˆ Ù‡ÙŠÙƒ",
    "Ù…Ùˆ ÙƒØ«ÙŠØ±",
    "Ù„Ø³Ø§ØªÙ†ÙŠ",
    "Ù„Ø³Ø§ØªÙƒ"
  ];

  // Ø®Ù„ÙŠØ¬ÙŠØ©
  const gulfWords = [
    "ÙˆØ§ÙŠØ¯",
    "ÙˆØ§Ø¬Ø¯",
    "Ø²ÙˆØ¯",
    "Ù…Ø±Ù‡",
    "Ù…Ø±Ø© Ø­Ù„Ùˆ",
    "Ø­ÙŠÙ„",
    "Ø´Ù„ÙˆÙ†",
    "Ø´Ùˆ Ø±Ø§ÙŠÙƒ",
    "ÙŠØ§ Ø±Ø¬Ø§Ù„",
    "ØªÙˆÙ‡",
    "ØªÙˆÙ†ÙŠ",
    "Ø³ÙˆÙŠ",
    "Ø³ÙˆÙŠØª",
    "Ø¯ÙˆÙ…",
    "Ù…Ù‚Ù‡ÙˆØ±"
  ];

  // Ù…ØµØ±ÙŠØ©
  const egyptWords = [
    "Ø§Ø²Ø§ÙŠ",
    "Ø§Ø²Ø§Ù‰",
    "Ù„ÙŠÙ‡",
    "ÙÙŠÙ†",
    "ÙƒÙˆÙŠØ³",
    "ØªÙ…Ø§Ù… Ø§ÙˆÙŠ",
    "Ø§ÙˆÙŠ",
    "Ø®Ø§Ù„Øµ",
    "Ù„Ø³Ù‡",
    "Ø¯Ù„ÙˆÙ‚ØªÙŠ",
    "Ø¯Ù„ÙˆÙ‚ØªÙ‰",
    "Ø¹Ø§ÙŠØ²",
    "Ø¹Ø§ÙˆØ²Ù‡",
    "Ø¹Ø§ÙŠØ²Ø©",
    "Ø¬Ø§Ù…Ø¯",
    "Ø¨Ø¬Ø¯",
    "ØªØ­ÙÙ‡",
    "ØªØ­ÙØ©"
  ];

  // Ù…ØºØ§Ø±Ø¨ÙŠØ©
  const maghrebWords = [
    "Ø¨Ø²Ø§Ù",
    "Ø¨Ø²Ù‘Ø§Ù",
    "ÙˆØ§Ø´",
    "Ø´Ù†Ùˆ",
    "Ø´Ø­Ø§Ù„",
    "Ø¨Ø§ØºÙŠ",
    "Ø¨ØºÙŠØª",
    "Ø¯Ø§Ø¨Ø§",
    "Ù‡ÙƒØ§",
    "Ù‡ÙƒØ§Ùƒ",
    "Ø¨Ø±Ø´Ø§"
  ];

  if (containsAny(cleanText, levantWords)) return "levant";
  if (containsAny(cleanText, gulfWords)) return "gulf";
  if (containsAny(cleanText, egyptWords)) return "egypt";
  if (containsAny(cleanText, maghrebWords)) return "maghreb";

  return "msa"; // ÙØµØ­Ù‰ / Ø¹Ø§Ù… Ø¹Ø±Ø¨ÙŠ Ø¹Ø§Ù…
}

/* ============== Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ© Ù„Ù„Ù†ÙˆØ§ÙŠØ§ ============== */

/**
 * 1) Ù†ÙŠØ© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙˆØªØ·ÙˆÙŠØ± Ø§Ù„Ø£Ø¹Ù…Ø§Ù„
 *    (Ù‡ÙŠ Ø§Ù„Ù†ÙŠØ© Ø§Ù„ÙˆØ­ÙŠØ¯Ø© Ø§Ù„ØªÙŠ ØªØ³ØªØ¯Ø¹ÙŠ Gemini)
 */
const AI_BUSINESS_KEYWORDS = [
  // Ø¹Ø±Ø¨ÙŠ Ø¹Ø§Ù… Ø¹Ù† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
  "Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ",
  "Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ",
  "Ø°ÙƒØ§Ø¡ Ø¥ØµØ·Ù†Ø§Ø¹ÙŠ",
  "Ø°ÙƒØ§Ø¡ ØµÙ†Ø§Ø¹ÙŠ",
  "Ø°ÙƒØ§Ø¡ ØµÙ†Ø¹ÙŠ",
  "ØªØ¹Ù„Ù… Ø¢Ù„ÙŠ",
  "ØªØ¹Ù„Ù… Ø¢Ù„Ù‰",
  "ØªØ¹Ù„Ù… Ø¹Ù…ÙŠÙ‚",
  "Ù†Ù…ÙˆØ°Ø¬ Ù„ØºÙˆÙŠ",
  "Ù†Ù…Ø§Ø°Ø¬ Ù„ØºÙˆÙŠØ©",
  "Ù†Ù…ÙˆØ°Ø¬ Ù„ØºØ©",
  "Ø¨Ø±ÙˆÙ…Ø¨Øª",
  "Ø¨Ø±ÙˆÙ…Ø¨ØªØ§Øª",
  "Ø§ÙˆØªÙˆÙ…Ø§ØªÙŠØ´Ù†",
  "Ø£ØªÙ…ØªØ©",
  "Ø§Ù”ØªÙ…ØªØ©",
  "Ø§ØªÙ…ØªØ©",
  "ØªØ´Ø§Øª Ø¨ÙˆØª",
  "Ø´Ø§Øª Ø¨ÙˆØª",
  "Ø±ÙˆØ¨ÙˆØª Ø¯Ø±Ø¯Ø´Ø©",
  "Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ",
  "ÙˆÙƒÙŠÙ„ Ø°ÙƒÙŠ",
  "Ø¹Ù…ÙŠÙ„ Ø°ÙƒÙŠ",

  // Ø£Ø¯ÙˆØ§Øª / Ù…Ù†ØµØ§Øª Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ
  "Ø´Ø§Øª Ø¬ÙŠ Ø¨ÙŠ ØªÙŠ",
  "chatgpt",
  "chat gpt",
  "chat-gpt",
  "gpt",
  "Ø¬ÙŠ Ø¨ÙŠ ØªÙŠ",
  "Ø¬ÙŠØ¨Øª",
  "gemini",
  "Ø¬ÙŠÙ…ÙŠÙ†ÙŠ",
  "bard",
  "openai",
  "Ø£ÙˆØ¨Ù† Ø¥ÙŠÙ‡ Ø¢ÙŠ",
  "novabot",
  "Ù†ÙˆÙØ§ Ø¨ÙˆØª",
  "nova bot",
  "Ù†ÙˆÙØ§ Ù„ÙŠÙ†Ùƒ",
  "novalink",
  "novalink ai",

  // Ù…Ø­ØªÙˆÙ‰ ÙˆØªØ³ÙˆÙŠÙ‚
  "ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù…Ø­ØªÙˆÙ‰",
  "ØªÙˆÙ„ÙŠØ¯ Ù†ØµÙˆØµ",
  "ÙƒØªØ§Ø¨Ø© Ù…Ø­ØªÙˆÙ‰",
  "ÙƒØªØ§Ø¨Ø© Ø§Ø¹Ù„Ø§Ù†ÙŠØ©",
  "ÙƒØªØ§Ø¨Ø© Ø¥Ø¹Ù„Ø§Ù†ÙŠØ©",
  "ÙƒØªØ§Ø¨Ø© Ù…Ù‚Ø§Ù„Ø§Øª",
  "Ù…Ø­ØªÙˆÙ‰ Ø³ÙˆØ´ÙŠØ§Ù„",
  "Ø³ÙˆØ´ÙŠØ§Ù„ Ù…ÙŠØ¯ÙŠØ§",
  "Ù…Ø­ØªÙˆÙ‰ ØªØ±ÙˆÙŠØ¬ÙŠ",
  "ØªØ­Ø³ÙŠÙ† Ù…Ø­Ø±ÙƒØ§Øª Ø§Ù„Ø¨Ø­Ø«",
  "Ø³ÙŠÙˆ",
  "seo",
  "Ù…Ø§Ø±ÙƒØªÙ†Ø¬",
  "marketing",
  "content",
  "copywriting",
  "copy writer",
  "Ø­Ù…Ù„Ø§Øª Ø§Ø¹Ù„Ø§Ù†ÙŠØ©",
  "Ø­Ù…Ù„Ø§Øª Ø¥Ø¹Ù„Ø§Ù†ÙŠØ©",
  "Ø§Ø¹Ù„Ø§Ù†Ø§Øª Ù…Ù…ÙˆÙ„Ø©",
  "Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù…Ù…ÙˆÙ„Ø©",
  "Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ÙÙŠØ³Ø¨ÙˆÙƒ",
  "Ø§Ø¹Ù„Ø§Ù†Ø§Øª ÙÙŠØ³Ø¨ÙˆÙƒ",
  "ÙÙŠØ³Ø¨ÙˆÙƒ Ø§Ø¯Ø²",
  "facebook ads",
  "instagram ads",
  "Ø§Ù†Ø³ØªØºØ±Ø§Ù… Ø§Ø¯Ø²",

  // ØªØ¹Ù„ÙŠÙ‚ ØµÙˆØªÙŠ Ùˆ TTS Ø¶Ù…Ù† Ù†ÙØ³ Ø§Ù„Ù†ÙŠØ©
  "ØªØ¹Ù„ÙŠÙ‚ ØµÙˆØªÙŠ",
  "voice over",
  "voice-over",
  "tts",
  "text to speech",
  "Ù†Øµ Ø§Ù„Ù‰ ÙƒÙ„Ø§Ù…",
  "Ù†Øµ Ø¥Ù„Ù‰ ÙƒÙ„Ø§Ù…",
  "ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ ØµÙˆØª",
  "ØµÙˆØª Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ",
  "Ø§ØµÙˆØ§Øª Ø§ØµØ·Ù†Ø§Ø¹ÙŠØ©",
  "Ø£ØµÙˆØ§Øª Ø§ØµØ·Ù†Ø§Ø¹ÙŠØ©",
  "murf",
  "elevenlabs",
  "Ø¯Ø±ÙŠØ¬Ø§Øª",
  "daryjat",

  // Ø¨Ø²Ù†Ø³ / Ù…Ø´Ø§Ø±ÙŠØ¹ / Ù…ØªØ§Ø¬Ø± / Ø´Ø±ÙƒØ§Øª
  "Ù…Ø´Ø±ÙˆØ¹ÙŠ",
  "Ù…Ø´Ø±ÙˆØ¹ÙŠ Ø§Ù„Ø®Ø§Øµ",
  "Ù…Ø´Ø±ÙˆØ¹",
  "Ù…Ø´Ø±ÙˆØ¹ ØªØ¬Ø§Ø±ÙŠ",
  "Ù…Ø´Ø±ÙˆØ¹ Ø§ÙˆÙ†Ù„Ø§ÙŠÙ†",
  "Ù…Ø´Ø±ÙˆØ¹ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†",
  "Ø§Ù„Ø¨Ø²Ù†Ø³",
  "Ø¨Ø²Ù†Ø³",
  "business",
  "startup",
  "Ø³ØªØ§Ø±Øª Ø§Ø¨",
  "Ø³ØªØ§Ø±ØªØ§Ø¨",
  "Ø±ÙŠØ§Ø¯Ø© Ø§Ø¹Ù…Ø§Ù„",
  "Ø±ÙŠØ§Ø¯Ø© Ø£Ø¹Ù…Ø§Ù„",
  "Ø±Ø§Ø¦Ø¯ Ø§Ø¹Ù…Ø§Ù„",
  "Ø±Ø§Ø¦Ø¯ Ø£Ø¹Ù…Ø§Ù„",
  "ØªØ³ÙˆÙŠÙ‚",
  "ØªØ³ÙˆÙŠÙ‚ Ø±Ù‚Ù…ÙŠ",
  "digital marketing",
  "Ù…Ø¨ÙŠØ¹Ø§Øª",
  "sales",
  "ØªØ·ÙˆÙŠØ± Ø§Ù„Ø§Ø¹Ù…Ø§Ù„",
  "ØªØ·ÙˆÙŠØ± Ø§Ù„Ø£Ø¹Ù…Ø§Ù„",
  "ØªØ·ÙˆÙŠØ± Ù…Ø´Ø±ÙˆØ¹ÙŠ",
  "ØªØ·ÙˆÙŠØ± Ø´Ø±ÙƒØªÙŠ",
  "ØªØ·ÙˆÙŠØ± Ø§Ù„Ø´Ø±ÙƒØ©",
  "Ø§Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆÙ‚Øª",
  "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆÙ‚Øª",
  "Ø§Ù†ØªØ§Ø¬ÙŠØ©",
  "Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠØ©",
  "productivity",
  "Ù†Ù…Ùˆ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹",
  "Ù†Ù…Ùˆ Ø§Ù„Ø¨Ø²Ù†Ø³",
  "Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡",
  "Ø¬Ø°Ø¨ Ø¹Ù…Ù„Ø§Ø¡",
  "ØªÙˆØ³ÙŠØ¹ Ù…Ø´Ø±ÙˆØ¹ÙŠ",
  "ØªÙˆØ³ÙŠØ¹ Ø´Ø±ÙƒØªÙŠ",
  "Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ØªÙØ§Ø¹Ù„",
  "Ø²ÙŠØ§Ø¯Ø© ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†",
  "Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©",
  "ØµÙØ­Ø© ØªØ¬Ø§Ø±ÙŠØ©",
  "Ø­Ø³Ø§Ø¨ ØªØ¬Ø§Ø±ÙŠ",
  "Ù…ØªØ¬Ø± Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ",
  "Ù…ØªØ¬Ø± Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ",
  "Ù…ØªØ¬Ø± Ø§ÙˆÙ†Ù„Ø§ÙŠÙ†",
  "Ù…ØªØ¬Ø± Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†",
  "ecommerce",
  "e-commerce",
  "Ø´ÙˆØ¨ÙŠÙØ§ÙŠ",
  "shopify",
  "ÙˆÙˆÙƒÙˆÙ…Ø±Ø³",
  "woocommerce",

  // Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠØ´Ù† ÙˆÙ…Ø³Ø§Ø±Ø§Øª Ø¹Ù…Ù„
  "workflow",
  "workflows",
  "automation",
  "automations",
  "Ø±Ø¨Ø· Ø§Ù„Ø§Ø¯ÙˆØ§Øª",
  "Ø±Ø¨Ø· Ø§Ù„Ø£Ø¯ÙˆØ§Øª",
  "ØªÙƒØ§Ù…Ù„ Ø§Ù„Ø§Ø¯ÙˆØ§Øª",
  "ØªÙƒØ§Ù…Ù„ Ø§Ù„Ø£Ø¯ÙˆØ§Øª",
  "zapier",
  "make.com",
  "integromat",

  // ÙÙ„ÙˆØ³ / Ø¯Ø®Ù„ Ø¥Ø¶Ø§ÙÙŠ Ù…Ø±ØªØ¨Ø· Ø¨Ø£Ø¯ÙˆØ§Øª Ø±Ù‚Ù…ÙŠØ©
  "Ø¯Ø®Ù„ Ø§Ø¶Ø§ÙÙŠ",
  "Ø¯Ø®Ù„ Ø¥Ø¶Ø§ÙÙŠ",
  "side hustle",
  "Ø¯Ø®Ù„ Ø¬Ø§Ù†Ø¨ÙŠ",
  "Ù…Ø´Ø±ÙˆØ¹ Ø¬Ø§Ù†Ø¨ÙŠ",
  "Ø¹Ù…Ù„ Ø­Ø±",
  "freelance",
  "freelancing",
  "Ø¯Ø±ÙˆØ¨ Ø´ÙŠØ¨Ù†Ø¬",
  "Ø¯Ø±ÙˆØ¨Ø´ÙŠØ¨ÙŠÙ†Ø¬",
  "ØªØ³ÙˆÙŠÙ‚ Ø¨Ø§Ù„Ø¹Ù…ÙˆÙ„Ø©",
  "Ø§ÙÙ„ÙŠÙŠØª",
  "affiliate",
  "affiliate marketing",

  // Ù…ØµØ·Ù„Ø­Ø§Øª ØªÙ‚Ù†ÙŠØ© Ø¹Ø§Ù…Ø© Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø§Ù„Ù€ AI
  "ai",
  "artificial intelligence",
  "machine learning",
  "deep learning",
  "rag",
  "retrieval augmented generation",
  "embeddings",
  "ÙÙŠÙƒØªÙˆØ±",
  "vector search",
  "llm",
  "large language model",
  "agents",
  "ai agent",
  "agentic",
  "fine tuning",
  "ØªØ¯Ø±ÙŠØ¨ Ù†Ù…ÙˆØ°Ø¬",
  "ØªØ®ØµÙŠØµ Ù†Ù…ÙˆØ°Ø¬"
];

const FOLLOWUP_KEYWORDS = [
  "ÙˆØ¶Ø­ Ø§ÙƒØ«Ø±",
  "ÙØ³Ø± Ø§ÙƒØ«Ø±",
  "Ø§Ø´Ø±Ø­ Ø§ÙƒØ«Ø±",
  "ÙƒÙ…Ù„",
  "ØªØ§Ø¨Ø¹",
  "Ø²ÙŠØ¯Ù†ÙŠ",
  "Ø§Ø­ÙƒÙŠ Ø§ÙƒØ«Ø±",
  "Ø­ÙƒÙŠ Ø§ÙƒØ«Ø±",
  "Ø·ÙŠØ¨ Ø¨Ø¹Ø¯ÙŠÙ†",
  "Ø·ÙŠØ¨ Ø´Ùˆ Ø¨Ø¹Ø¯ÙŠÙ†",
  "Ø·ÙŠØ¨ ÙˆØ¨Ø¹Ø¯ÙŠÙ†",
  "Ø®Ù„ÙŠÙ†Ø§ Ù†ÙƒÙ…Ù„",
  "Ù†ÙƒÙ…Ù„",
  "continue",
  "go on",
  "tell me more",
  "give me more",
  "more details",
  "more detail",
  "explain more",
  "explain further",
  "go deeper"
];

/**
 * 1-bis) ÙƒÙ„Ù…Ø§Øª Ø¨Ø²Ù†Ø³ Ù‚ÙˆÙŠØ© (Ø¨Ø¯ÙˆÙ† Ø°ÙƒØ± AI ØµØ±ÙŠØ­)
 * ØªØ³ØªØ®Ø¯Ù… Ù„Ù„ÙØµÙ„ Ø¨ÙŠÙ† "Ø³ÙŠØ§Ø±Ø§Øª + Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ" (Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚)
 * Ùˆ "Ù…Ø´Ø±ÙˆØ¹ÙŠ / Ù…ØªØ¬Ø±ÙŠ / Ø´Ø±ÙƒØªÙŠ / Ù…Ø¨ÙŠØ¹Ø§Øª" (Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚).
 */
const BUSINESS_ONLY_KEYWORDS = [
  "Ù…Ø´Ø±ÙˆØ¹ÙŠ",
  "Ù…Ø´Ø±ÙˆØ¹ÙŠ Ø§Ù„Ø®Ø§Øµ",
  "Ù…Ø´Ø±ÙˆØ¹",
  "Ù…Ø´Ø±ÙˆØ¹ ØªØ¬Ø§Ø±ÙŠ",
  "Ù…Ø´Ø±ÙˆØ¹ Ø§ÙˆÙ†Ù„Ø§ÙŠÙ†",
  "Ù…Ø´Ø±ÙˆØ¹ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†",
  "Ø´Ø±ÙƒØªÙŠ",
  "Ø§Ù„Ø´Ø±ÙƒØ©",
  "Ø´Ø±ÙƒØ©",
  "Ø¨ÙŠØ²Ù†Ø³",
  "Ø¨Ø²Ù†Ø³",
  "business",
  "startup",
  "Ø³ØªØ§Ø±Øª Ø§Ø¨",
  "Ø³ØªØ§Ø±ØªØ§Ø¨",
  "Ù…ØªØ¬Ø± Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠ",
  "Ù…ØªØ¬Ø± Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ",
  "Ù…ØªØ¬Ø± Ø§ÙˆÙ†Ù„Ø§ÙŠÙ†",
  "Ù…ØªØ¬Ø± Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†",
  "Ù…ØªØ¬Ø±",
  "Ù…ØªØ¬Ø±ÙŠ",
  "Ù…ØªØ¬Ø±Ù‰",
  "Ø­Ø³Ø§Ø¨ ØªØ¬Ø§Ø±ÙŠ",
  "ØµÙØ­Ø© ØªØ¬Ø§Ø±ÙŠØ©",
  "Ù…Ù†ØªØ¬ Ø±Ù‚Ù…ÙŠ",
  "Ø®Ø¯Ù…Ø© Ø±Ù‚Ù…ÙŠØ©",
  "Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ØªÙØ§Ø¹Ù„",
  "Ø²ÙŠØ§Ø¯Ø© ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†",
  "Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª",
  "Ø±ÙØ¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª",
  "Ù†Ù…Ùˆ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹",
  "Ù†Ù…Ùˆ Ø§Ù„Ø¨Ø²Ù†Ø³",
  "ØªØ³ÙˆÙŠÙ‚",
  "ØªØ³ÙˆÙŠÙ‚ Ø±Ù‚Ù…ÙŠ",
  "marketing",
  "Ù…Ø¨ÙŠØ¹Ø§Øª",
  "sales",
  "Ø¹Ù…Ù„ Ø­Ø±",
  "freelance",
  "Ø¯Ø®Ù„ Ø¥Ø¶Ø§ÙÙŠ",
  "Ø¯Ø®Ù„ Ø§Ø¶Ø§ÙÙŠ",
  "side hustle"
];

// 2) ØªØ±Ø­ÙŠØ¨
const GREETING_KEYWORDS = [
  "Ù…Ø±Ø­Ø¨Ø§",
  "Ù…Ø±Ø­Ø¨Ø§Ø§",
  "Ø§Ù‡Ù„Ø§",
  "Ø£Ù‡Ù„Ø§",
  "Ø§Ù‡Ù„Ø§Ù‹",
  "Ø£Ù‡Ù„Ø§Ù‹",
  "Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…",
  "Ù‡Ø§ÙŠ",
  "Ù‡Ù„Ø§",
  "Ù‡Ù„Ø§ ÙˆØ§Ù„Ù„Ù‡",
  "Ù‡Ù„Ùˆ",
  "hi",
  "hello",
  "hey",
  "good morning",
  "good evening",
  "Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ±",
  "ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ±"
];

// 3) Ø´ÙƒØ± / Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ©
const THANKS_POSITIVE_KEYWORDS = [
  "Ø´ÙƒØ±Ø§",
  "Ø´ÙƒØ±Ø§Ù‹",
  "Ø´ÙƒØ±Ù†",
  "Ø«Ø§Ù†ÙƒØ³",
  "ÙŠØ¹Ø·ÙŠÙƒ Ø§Ù„Ø¹Ø§ÙÙŠØ©",
  "ÙŠØ¹Ø·ÙŠÙƒÙˆ Ø§Ù„Ø¹Ø§ÙÙŠØ©",
  "ÙŠØ³Ù„Ù…ÙˆØ§",
  "ØªØ³Ù„Ù…",
  "Ù…Ù…ØªØ§Ø²",
  "Ø±Ø§Ø¦Ø¹",
  "Ø­Ù„Ùˆ",
  "Ø¬Ù…ÙŠÙ„",
  "perfect",
  "thanks",
  "thank you",
  "great",
  "awesome",
  "useful",
  "Ø§ÙØ¯ØªÙ†ÙŠ",
  "ÙØ¯ØªÙ†ÙŠ",
  "Ø§ÙØ¯ØªÙ†ÙŠ ÙƒØ«ÙŠØ±",
  "Ù…ÙÙŠØ¯ Ø¬Ø¯Ø§",
  "Ù…ÙÙŠØ¯ Ø¬Ø¯Ù‹Ø§"
];

// 4) Ù…Ø²Ø§Ø¬ Ø³Ù„Ø¨ÙŠ / Ø¥Ø­Ø¨Ø§Ø·
const NEGATIVE_MOOD_KEYWORDS = [
  "Ù…Ø­Ø¨Ø·",
  "Ù…Ø­Ø¨Ø·Ø©",
  "ØªØ¹Ø¨Ø§Ù†",
  "ØªØ¹Ø¨Ø§Ù†Ø©",
  "Ø²Ù‡Ù‚Ø§Ù†",
  "Ø²Ù‡Ù‚Ø§Ù†Ù‡",
  "Ø²Ø¹Ù„Ø§Ù†",
  "Ø²Ø¹Ù„Ø§Ù†Ù‡",
  "ÙØ§Ø´Ù„",
  "Ø­Ø§Ø³ Ø­Ø§Ù„ÙŠ ÙØ§Ø´Ù„",
  "Ø­Ø§Ø³Ø© Ø­Ø§Ù„ÙŠ ÙØ§Ø´Ù„Ø©",
  "ÙŠØ§Ø¦Ø³",
  "ÙŠØ§Ø¦Ø³Ø©",
  "Ø§Ø­Ø¨Ø·Øª",
  "ØªØ¹ÙŠØ³",
  "Ù…ÙƒØªØ¦Ø¨",
  "Ù…Ø­Ø¨Ø· Ø¬Ø¯Ø§",
  "Ù…Ø¯Ø§ÙŠÙ‚",
  "Ù…ØªØ¶Ø§ÙŠÙ‚",
  "Ù…Ø´ Ù†Ø§ÙØ¹",
  "Ù…Ø´ Ù†Ø§ÙØ¹ Ù…Ø¹ÙŠ",
  "Ù…Ø´ Ø±Ø§Ø¶ÙŠ",
  "Ù…Ø´ Ø±Ø§Ø¶ÙŠØ©",
  "failed",
  "depressed"
];

// 5) Ø§Ø´ØªØ±Ø§Ùƒ / Ù†Ø´Ø±Ø©
const SUBSCRIBE_KEYWORDS = [
  "Ø§Ø´ØªØ±Ùƒ",
  "Ø§Ø´ØªØ±Ø§Ùƒ",
  "Ø§Ù„Ù†Ø´Ø±Ø©",
  "Ù†Ø´Ø±Ø© Ù†ÙˆÙØ§",
  "newsletter",
  "mailing list",
  "subscribe",
  "ØªØ§Ø¨Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª",
  "Ø¨Ø±ÙŠØ¯Ùƒ",
  "Ø¨Ø±ÙŠØ¯ÙŠ",
  "Ø§ÙŠÙ…ÙŠÙ„",
  "Ø¥ÙŠÙ…ÙŠÙ„",
  "email updates"
];

// 6) ØªØ¹Ø§ÙˆÙ† / Ø´Ø±Ø§ÙƒØ©
const COLLAB_KEYWORDS = [
  "ØªØ¹Ø§ÙˆÙ†",
  "Ø´Ø±Ø§ÙƒØ©",
  "Ø´Ø±ÙŠÙƒ",
  "Ø§Ø±ÙŠØ¯ Ø§Ù„ØªØ¹Ø§ÙˆÙ†",
  "Ø§Ø±ÙŠØ¯ Ø´Ø±Ø§ÙƒØ©",
  "ØªØ¹Ø§ÙˆÙ† Ù…Ø¹ Ù†ÙˆÙØ§ Ù„ÙŠÙ†Ùƒ",
  "Ø´Ø±Ø§ÙƒØ© Ù…Ø¹ Ù†ÙˆÙØ§ Ù„ÙŠÙ†Ùƒ",
  "Ù†Ø¹Ù…Ù„ Ù…Ø¹ Ø¨Ø¹Ø¶",
  "Ø±Ø¹Ø§ÙŠØ© Ù…Ø­ØªÙˆÙ‰",
  "Ø±Ø¹Ø§ÙŠÙ‡ Ù…Ø­ØªÙˆÙ‰",
  "sponsorship",
  "sponsored content",
  "collab",
  "collaboration",
  "partnership"
];

// 7) Ø§Ø³ØªØ´Ø§Ø±Ø© Ø£Ùˆ Ø´Ø±Ø§Ø¡ Ø®Ø¯Ù…Ø©
const CONSULTING_KEYWORDS = [
  "Ø§Ø³ØªØ´Ø§Ø±Ø©",
  "Ø§Ø³ØªØ´Ø§Ø±Ù‡",
  "Ø§Ø³ØªØ´Ø§Ø±Ø© Ù…Ø¯ÙÙˆØ¹Ø©",
  "Ø§Ø³ØªØ´Ø§Ø±Ø© Ù…Ø¯ÙÙˆØ¹Ù‡",
  "Ø§Ø³ØªØ´Ø§Ø±Ø© Ù…Ø¹ÙƒÙ…",
  "ÙƒÙŠÙ Ù†ØªÙˆØ§ØµÙ„",
  "ÙƒÙŠÙ Ø§ØªÙˆØ§ØµÙ„",
  "Ø§Ø­Ø¬Ø² Ø¬Ù„Ø³Ø©",
  "Ø§Ø­Ø¬Ø² Ø§Ø³ØªØ´Ø§Ø±Ø©",
  "book consultation",
  "consultation",
  "how to contact",
  "contact you",
  "buy service",
  "Ø®Ø¯Ù…Ø§ØªÙƒÙ…"
];

// 8) Ø§Ø³ØªÙØ³Ø§Ø± Ø¹Ù† Ù†ÙˆÙØ§ Ù„ÙŠÙ†Ùƒ
const NOVALINK_INFO_KEYWORDS = [
  "Ù…Ø§ Ù‡ÙŠ Ù†ÙˆÙØ§ Ù„ÙŠÙ†Ùƒ",
  "Ù…Ø§ Ù‡ÙŠ Ù†ÙˆÙØ§Ù„ÙŠÙ†Ùƒ",
  "Ù…Ø§ Ù‡ÙŠ novalink",
  "Ù†ÙˆÙØ§ Ù„ÙŠÙ†Ùƒ ÙƒÙŠÙ Ø¨Ø¯Ø£Øª",
  "ÙƒÙŠÙ Ø¨Ø¯Ø£Øª Ù†ÙˆÙØ§ Ù„ÙŠÙ†Ùƒ",
  "Ù‚ØµØ© Ù†ÙˆÙØ§ Ù„ÙŠÙ†Ùƒ",
  "novalink story",
  "novalink mission",
  "novalink goals",
  "novalink vision",
  "Ù…Ù† Ù‡Ùˆ Ù†ÙˆÙØ§ Ø¨ÙˆØª",
  "Ù…Ù† Ù‡ÙŠ Ù†ÙˆÙØ§ Ù„ÙŠÙ†Ùƒ",
  "why novalink",
  "what is novalink",
  "Ù…Ù† Ù‡Ùˆ Ù†ÙˆÙØ§",
  "Ù…Ù† Ù‡Ùˆ Ù†ÙˆÙØ§ Ø¨ÙˆØª"
];

// 9) Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚ (Ù‡Ø§Ø±Ø¯)
const HARD_OUT_OF_SCOPE_KEYWORDS = [
  // Ø³ÙŠØ§Ø±Ø§Øª
  "Ø³ÙŠØ§Ø±Ø©",
  "Ø³ÙŠØ§Ø±Ø§Øª",
  "car",
  "cars",
  "bmw",
  "mercedes",
  "toyota",
  "ÙƒÙŠØ§",
  "kia",
  "honda",
  "Ù‡ÙˆÙ†Ø¯Ø§",
  "tesla",
  "ØªØ³Ù„Ø§",

  // Ù…ÙˆØ¶Ø© / Ø¹Ø·ÙˆØ±
  "Ø¹Ø·Ø±",
  "Ø¹Ø·ÙˆØ±",
  "Ø¨Ø±ÙÙŠÙˆÙ…",
  "Ø¨ÙŠØ±ÙÙŠÙˆÙ…",
  "Ù…ÙˆØ¶Ø©",
  "ÙØ§Ø´ÙˆÙ†",
  "Ø§Ø²ÙŠØ§Ø¡",
  "Ø£Ø²ÙŠØ§Ø¡",
  "Ù…Ù„Ø§Ø¨Ø³",
  "Ù„Ø¨Ø³",
  "fashion",
  "runway",
  "Ø´Ø§Ù†ÙŠÙ„",
  "dior",
  "Ù„ÙˆØ¨ÙˆØªØ§Ù†",
  "Ø´Ù†Ø·",
  "Ø­Ù‚Ø§Ø¦Ø¨",

  // Ø³ÙØ± / Ø³ÙŠØ§Ø­Ø©
  "Ø³ÙØ±",
  "Ø³ÙŠØ§Ø­Ø©",
  "Ø³ÙŠØ§Ø­Ù‡",
  "Ø±Ø­Ù„Ø§Øª",
  "Ø±Ø­Ù„Ø©",
  "ØªØ°Ø§ÙƒØ± Ø·ÙŠØ±Ø§Ù†",
  "Ø·ÙŠØ±Ø§Ù†",
  "ÙÙŠØ²Ø§",
  "Ù‡Ø¬Ø±Ø©",
  "Ù‡Ø¬Ø±Ù‡",
  "Ø§Ù‚Ø§Ù…Ø©",
  "Ø¥Ù‚Ø§Ù…Ø©",
  "ØªØ£Ø´ÙŠØ±Ø©",
  "ØªØ§Ø´ÙŠØ±Ø©",
  "ØªØ£Ø´ÙŠØ±Ù‡",
  "ØªØ§Ø´ÙŠØ±Ù‡",
  "ÙÙ†Ø¯Ù‚",
  "ÙÙ†Ø§Ø¯Ù‚",
  "Ø­Ø¬Ø² ÙÙ†Ø¯Ù‚",
  "Ø­Ø¬ÙˆØ²Ø§Øª",

  // Ø±ÙŠØ§Ø¶Ø©
  "ÙƒØ±Ø©",
  "ÙƒØ±Ø© Ù‚Ø¯Ù…",
  "Ù…Ø¨Ø§Ø±Ø§Ø©",
  "Ù…Ø§ØªØ´",
  "Ø¨Ø·ÙˆÙ„Ø©",
  "Ø±ÙŠØ§Ø¶Ø©",
  "Ø±ÙŠØ§Ø¶Ù‡",
  "ØªÙ…Ø±ÙŠÙ†",
  "Ø¬ÙŠÙ…",
  "ÙƒÙ…Ø§Ù„ Ø§Ø¬Ø³Ø§Ù…",
  "ÙƒÙ…Ø§Ù„ Ø£Ø¬Ø³Ø§Ù…",
  "bodybuilding",

  // Ù…ÙˆØ³ÙŠÙ‚Ù‰ / Ø£ÙÙ„Ø§Ù… / Ø£Ù„Ø¹Ø§Ø¨
  "Ù…ÙˆØ³ÙŠÙ‚Ù‰",
  "Ø£ØºÙ†ÙŠØ©",
  "Ø§ØºÙ†ÙŠØ©",
  "Ø£ØºØ§Ù†ÙŠ",
  "Ø§ØºØ§Ù†ÙŠ",
  "ÙÙŠÙ„Ù…",
  "Ø§ÙÙ„Ø§Ù…",
  "Ø£ÙÙ„Ø§Ù…",
  "Ù…Ø³Ù„Ø³Ù„",
  "Ù…Ø³Ù„Ø³Ù„Ø§Øª",
  "Ø¨Ù„Ø§ÙŠØ³ØªÙŠØ´Ù†",
  "ps5",
  "ps4",
  "Ø§ÙƒØ³ Ø¨ÙˆÙƒØ³",
  "xbox",
  "Ù†ÙŠÙ†ØªÙ†Ø¯Ùˆ",
  "Ù„Ø¹Ø¨Ø©",
  "Ø§Ù„Ø¹Ø§Ø¨",
  "Ø£Ù„Ø¹Ø§Ø¨",

  // ØªØ¹Ù„ÙŠÙ… Ø¬Ø§Ù…Ø¹ÙŠ / Ø§Ù…ØªØ­Ø§Ù†Ø§Øª (Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¨Ø²Ù†Ø³/AI)
  "Ø¬Ø§Ù…Ø¹Ø©",
  "Ø¬Ø§Ù…Ø¹Ù‡",
  "Ø§Ù…ØªØ­Ø§Ù†",
  "Ø§Ù…ØªØ­Ø§Ù†Ø§Øª",
  "Ù…Ø¯Ø±Ø³Ø©",
  "Ù…Ø¯Ø±Ø³Ù‡",
  "Ø·Ù„Ø§Ø¨",
  "Ø·Ø§Ù„Ø¨",
  "Ù…Ø¹Ù„Ù…",
  "Ù…Ø¹Ù„Ù…Ø©"
];

/* ============== Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ============== */

export async function detectNovaIntent(userMessage = "") {
  const original = (userMessage || "").trim();
  if (!original) {
    return {
      intentId: "casual",
      confidence: 0,
      language: "ar",
      dialectHint: "msa",
      toneHint: "neutral",
      suggestedCard: null,
      aiScore: 0,
      bizScore: 0,
      followupScore: 0
    };
  }

  const language = detectLanguage(original);
  const clean = normalize(original);
  const dialectHint = language === "ar" ? detectDialect(clean) : "en";

  // =========================
  // 1) Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³ÙƒÙˆØ± Ù„ÙƒÙ„ Ù†ÙŠØ©
  // =========================
  const aiScore = scoreByKeywords(clean, AI_BUSINESS_KEYWORDS);
  const bizScore = scoreByKeywords(clean, BUSINESS_ONLY_KEYWORDS);
  const followupScore = scoreByKeywords(clean, FOLLOWUP_KEYWORDS);
  const greetScore = scoreByKeywords(clean, GREETING_KEYWORDS);
  const thanksScore = scoreByKeywords(clean, THANKS_POSITIVE_KEYWORDS);
  const negativeScore = scoreByKeywords(clean, NEGATIVE_MOOD_KEYWORDS);
  const subscribeScore = scoreByKeywords(clean, SUBSCRIBE_KEYWORDS);
  const collabScore = scoreByKeywords(clean, COLLAB_KEYWORDS);
  const consultScore = scoreByKeywords(clean, CONSULTING_KEYWORDS);
  const novalinkScore = scoreByKeywords(clean, NOVALINK_INFO_KEYWORDS);
  const hardOutScope = scoreByKeywords(clean, HARD_OUT_OF_SCOPE_KEYWORDS);

  const buildResult = (payload) => ({
    ...payload,
    aiScore,
    bizScore,
    followupScore
  });

  // =========================
  // 2) ÙƒØ´Ù "Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚" Ø¨Ù‚ÙˆØ©
  //    Ø£ÙŠ Ù…ÙˆØ¶ÙˆØ¹ Ø·Ø¨Ø®/Ø·Ù‚Ø³/Ø³ÙŠØ§Ø±Ø§Øª/Ù…ÙˆØ¶Ø©/Ø·Ø¨... Ø¨Ø¯ÙˆÙ† Ø¨Ø²Ù†Ø³
  // =========================
  if (hardOutScope > 0 && bizScore === 0) {
    return buildResult({
      intentId: "out_of_scope",
      confidence: 0.95,
      language,
      dialectHint,
      toneHint: "neutral",
      suggestedCard: null
    });
  }

  // =========================
  // 3) Ù†ÙˆØ§ÙŠØ§ ØªØ¹Ø±ÙŠÙ Ù†ÙˆÙØ§ Ù„ÙŠÙ†Ùƒ / Ù†ÙˆÙØ§ Ø¨ÙˆØª Ø¨Ø­ØªØ©
  // =========================
  if (novalinkScore > 0 && aiScore === 0) {
    return buildResult({
      intentId: "novalink_info",
      confidence: 0.9,
      language,
      dialectHint,
      toneHint: "neutral",
      suggestedCard: null
    });
  }

  // =========================
  // 4) Ø§Ø³ØªØ´Ø§Ø±Ø© Ø£Ùˆ Ø´Ø±Ø§Ø¡ Ø®Ø¯Ù…Ø©
  // =========================
  if (consultScore > 0) {
    return buildResult({
      intentId: "consulting_purchase",
      confidence: 0.9,
      language,
      dialectHint,
      toneHint: "neutral",
      suggestedCard: "bot_lead"
    });
  }

  // =========================
  // 5) ØªØ¹Ø§ÙˆÙ† / Ø´Ø±Ø§ÙƒØ©
  // =========================
  if (collabScore > 0) {
    return buildResult({
      intentId: "collaboration",
      confidence: 0.9,
      language,
      dialectHint,
      toneHint: "neutral",
      suggestedCard: "collaboration"
    });
  }

  // =========================
  // 6) Ø§Ø´ØªØ±Ø§Ùƒ / Ù†Ø´Ø±Ø©
  // =========================
  if (subscribeScore > 0) {
    return buildResult({
      intentId: "subscribe_interest",
      confidence: 0.9,
      language,
      dialectHint,
      toneHint: "positive",
      suggestedCard: "subscribe"
    });
  }

  // =========================
  // 7) Ø´ÙƒØ± / Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ©
  // =========================
  if (thanksScore > 0 && aiScore === 0) {
    return buildResult({
      intentId: "thanks_positive",
      confidence: 0.9,
      language,
      dialectHint,
      toneHint: "positive",
      suggestedCard: "subscribe"
    });
  }

  // =========================
  // 8) Ù…Ø²Ø§Ø¬ Ø³Ù„Ø¨ÙŠ / Ø¯Ø¹Ù… Ù…Ø¹Ù†ÙˆÙŠ
  // =========================
  if (negativeScore > 0 && aiScore === 0) {
    return buildResult({
      intentId: "negative_mood",
      confidence: 0.9,
      language,
      dialectHint,
      toneHint: "negative",
      suggestedCard: null
    });
  }

  // =========================
  // 9) ØªØ±Ø­ÙŠØ¨ Ø®Ø§Ù„Øµ (Ø¨Ø¯ÙˆÙ† Ø³ÙŠØ§Ù‚ Ø¢Ø®Ø±)
  // =========================
  if (greetScore > 0 && original.length <= 40 && aiScore === 0) {
    return buildResult({
      intentId: "greeting",
      confidence: 0.9,
      language,
      dialectHint,
      toneHint: "positive",
      suggestedCard: null
    });
  }

  // =========================
  // 10) Ø§Ø³ØªÙØ³Ø§Ø± Ø¹Ù† Ù†ÙˆÙØ§ Ù„ÙŠÙ†Ùƒ + AI Ù…Ø¹Ù‹Ø§
  //      (Ù…Ø«Ù„Ø§Ù‹: Ù…Ø§ Ù‡ÙŠ Ù†ÙˆÙØ§ Ù„ÙŠÙ†Ùƒ ÙˆÙ„Ù…Ø§Ø°Ø§ Ø£Ù†Ø´Ø¦ØªØŸ)
  // =========================
  if (novalinkScore > 0 && aiScore > 0) {
    return buildResult({
      intentId: "novalink_info",
      confidence: 0.9,
      language,
      dialectHint,
      toneHint: "neutral",
      suggestedCard: null
    });
  }

  // =========================
  // 11) Ù†ÙŠØ© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙˆØªØ·ÙˆÙŠØ± Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ (ONLY AI)
  // =========================
  if (aiScore > 0 || bizScore > 0) {
    let conf = 0.7;
    const combinedScore = aiScore + bizScore;
    if (combinedScore >= 4) conf = 0.95;
    else if (combinedScore >= 2) conf = 0.85;

    let suggestedCard = null;
    if (consultScore > 0) {
      suggestedCard = "bot_lead";
    } else if (subscribeScore > 0) {
      suggestedCard = "business_subscribe";
    }

    return buildResult({
      intentId: "ai_business",
      confidence: conf,
      language,
      dialectHint,
      toneHint: "neutral",
      suggestedCard
    });
  }

  // =========================
  // 12) Ø¥Ø°Ø§ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ ØªØ·Ø§Ø¨Ù‚ ÙˆØ§Ø¶Ø­
  //      â†’ ØªØ¹Ø§Ù…Ù„ ÙƒÙ€ Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†Ø·Ø§Ù‚
  // =========================
  return buildResult({
    intentId: "out_of_scope",
    confidence: 0.6,
    language,
    dialectHint,
    toneHint: "neutral",
    suggestedCard: null
  });
}
