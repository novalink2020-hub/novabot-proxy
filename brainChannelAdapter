// =======================================================
// NovaBrain v3.0 â€“ Unified Channel Adapter
// ÙŠØ­ÙˆÙ‘Ù„ Ø±Ø³Ø§Ø¦Ù„ Ø£ÙŠ Ù…Ù†ØµØ© Ø¥Ù„Ù‰ ØµÙŠØºØ© Ù…ÙˆØ­Ù‘Ø¯Ø© Ù„Ø¯Ù…Ø§Øº Ù†ÙˆÙØ§ Ø¨ÙˆØª
// Ø§Ù„Ù…Ø·ÙˆØ±: Ù…Ø­Ù…Ø¯ Ø£Ø¨Ùˆ Ø³Ù†ÙŠÙ†Ø© â€“ NOVALINK.AI
// =======================================================

const { processMessage } = require("./brainDecisionEngine");

// -------------------------------------------------------
// ğŸ”¥ 1) ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ÙˆØ§Ø±Ø¯Ø© Ù…Ù† Ø£ÙŠ Ù…Ù†ØµØ©
// -------------------------------------------------------

function normalizeIncomingMessage(channel, rawPayload) {
  try {
    switch (channel) {
      case "web":
        return {
          senderId: rawPayload?.sessionId || "web-user",
          message: rawPayload?.text || "",
          channel,
          metadata: {}
        };

      case "whatsapp":
        return {
          senderId: rawPayload?.from || "",
          message: rawPayload?.text?.body || "",
          channel,
          metadata: rawPayload
        };

      case "messenger":
        return {
          senderId: rawPayload?.sender?.id,
          message: rawPayload?.message?.text || "",
          channel,
          metadata: rawPayload
        };

      case "instagram":
        return {
          senderId: rawPayload?.sender?.id || "",
          message: rawPayload?.message?.text || "",
          channel,
          metadata: rawPayload
        };

      case "telegram":
        return {
          senderId: rawPayload?.message?.from?.id || "",
          message: rawPayload?.message?.text || "",
          channel,
          metadata: rawPayload
        };

      case "x":
        return {
          senderId: rawPayload?.sender_id || "",
          message: rawPayload?.text || "",
          channel,
          metadata: rawPayload
        };

      default:
        return {
          senderId: "unknown",
          message: "",
          channel: "unknown",
          metadata: rawPayload
        };
    }
  } catch (e) {
    console.error("âŒ normalizeIncomingMessage error:", e);
    return {
      senderId: "unknown",
      message: "",
      channel: "unknown",
      metadata: rawPayload
    };
  }
}

// -------------------------------------------------------
// ğŸ”¥ 2) ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø±Ø¯ Ù„Ù„ØµÙŠØºØ© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„ÙƒÙ„ Ù…Ù†ØµØ©
// -------------------------------------------------------

function formatOutgoingMessage(channel, text) {
  switch (channel) {
    case "web":
      return { reply: text };

    case "whatsapp":
      return {
        type: "whatsapp",
        body: {
          messaging_product: "whatsapp",
          text: { body: text }
        }
      };

    case "messenger":
      return {
        type: "messenger",
        body: {
          text
        }
      };

    case "instagram":
      return {
        type: "instagram",
        body: {
          text
        }
      };

    case "telegram":
      return {
        type: "telegram",
        body: {
          method: "sendMessage",
          text
        }
      };

    case "x":
      return {
        type: "x",
        body: {
          text
        }
      };

    default:
      return { reply: text };
  }
}

// -------------------------------------------------------
// ğŸ”¥ 3) Ù†Ù‚Ø·Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„: ØªÙØ³ØªØ¯Ø¹Ù‰ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
// -------------------------------------------------------

async function handleIncomingMessage(channel, rawPayload) {
  try {
    const normalized = normalizeIncomingMessage(channel, rawPayload);

    if (!normalized.message) {
      return formatOutgoingMessage(channel, "Ø£Ø­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø±Ø³Ø§Ù„Ø© Ù„Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ğŸ¤–");
    }

    // ğŸ§  Ø£Ø±Ø³Ù„ Ù„Ù„Ø¯Ù…Ø§Øº
    const brainResponse = await processMessage({
      text: normalized.message,
      userId: normalized.senderId,
      channel: normalized.channel,
      metadata: normalized.metadata
    });

    // Ø£Ø±Ø¬Ø¹ ØµÙŠØºØ© Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ù‚Ù†Ø§Ø©
    return formatOutgoingMessage(channel, brainResponse);
  } catch (e) {
    console.error("âŒ handleIncomingMessage error:", e);
    return formatOutgoingMessage(channel, "âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ØŒ Ø£Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©.");
  }
}

// -------------------------------------------------------
module.exports = {
  handleIncomingMessage
};
